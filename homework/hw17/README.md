# # 第十七章作业

## 作业1

如果你要为你们公司内部的 Agent 应用设计一套权限系统，你会定义哪些角色和权限？为什么

### 角色与权限说明

| 角色                                 | 权限                                                                                 | 说明                                                         |
| ------------------------------------ | ------------------------------------------------------------------------------------ | ------------------------------------------------------------ |
| **系统管理员（SysAdmin）**     | *所有权限：管理 Agent、用户、角色、全局配置、审计日志*                             | 全面控制权限，负责系统设置、权限分配、用户管理（高权限角色） |
| **Agent 管理员（AgentAdmin）** | *新增/修改/删除 Agent 实例；部署、启动/停止 Agent；配置权限策略；管理模型、知识库* | 管理和部署 Agent，适用于开发/运维其他团队协作                |
| **开发者（Developer）**        | *访问 Agent 开发环境、代码/脚本管理、部署测试 Agent；编辑模型、知识库*             | 参与 Agent 功能开发和迭代，与 AgentAdmin 分工明确            |
| **功能测试（QA）**             | *执行 Agent 特定任务或模拟请求；读取 Agent 输出；提交反馈*                         | 用于测试流程验证，不可修改生产 Agent 配置                    |
| **用户（User）**               | *使用 Agent 功能（如对话，查询、报告生成）；查看自己请求的结果*                    | 普通人员使用 Agent 的功能，不能访问系统配置或其他用户数据    |
| **合规审查（Compliance）**     | *只读 Agent 会话日志、对话记录、标记敏感内容*                                      | 审查和监察权限，对 Agent 对话内容进行巡查和标注              |
| **审计员（Auditor）**          | *访问全系统审计日志；跨 Agent 操作日志；生成审计报告*                              | 独立角色，只审查而不操作 Agent 或系统配置（职责分离）        |

### 为什么？

1. 角色职责清晰、分层管理
   按照组织结构与职责区分角色，避免权限混乱，方便管理与审计
2. 最小权限原则（Principle of Least Privilege）
   每个角色只授予完成工作所需的权限，防止权限滥用或越权行为
3. 职责分离（Separation of Duties）
   比如审计员与系统管理员权限互斥，减少内部滥用风险
4. 支持多团队协作
   允许跨团队以角色 + 权限集方式管理，清晰高效

## 作业2

你们公司有一个包含用户评论的数据集，计划用来微调一个情感分析模型。你会采取哪些隐私保护措施？具体如何操作？

以下是一些关键的隐私保护措施及具体操作步骤，涵盖数据处理、模型训练和部署的全流程：

### 1. **数据匿名化**

- **措施**：移除或匿名化数据集中的个人身份信息（PII），如姓名、电话号码、电子邮件地址、身份证号码等，防止用户身份被直接关联。
- **操作**：
  - 使用正则表达式或自然语言处理（NLP）工具（如spaCy、Presidio）扫描评论文本，识别和替换 PII。例如，将“张三”替换为“[USER]”，将“13812345678”替换为“[138****5678]”。
  - 对替换后的数据进行手动抽检，确保敏感信息被有效移除。
  - 如果评论中包含用户ID或其他唯一标识符，生成随机化的匿名ID（如UUID）进行替换，并保存映射关系（若需要）到加密存储中，仅限授权人员访问。

### 2. **数据最小化**

- **措施**：仅保留与情感分析任务直接相关的数据，剔除不必要的敏感信息。
- **操作**：
  - 分析情感分析任务的需求，只保留评论文本和情感标签（如正面、负面、中性），删除无关字段（如用户地理位置、IP地址）。
  - 如果需要上下文信息（如评论时间），将其泛化为较粗粒度的格式（如“2025年8月”而不是具体时间戳）。

### 3. **差分隐私**

- **措施**：在数据处理或模型训练中引入差分隐私，降低单个用户数据对模型输出的影响，防止通过模型推断出原始数据。
- **操作**：
  - 在数据预处理阶段，使用差分隐私算法（如Laplace或Gaussian机制）为情感标签或特征添加噪声。例如，使用Python库 `diffprivlib`对数据集进行扰动。
  - 在模型训练时，应用差分隐私优化算法（如DP-SGD，差分隐私随机梯度下降），通过工具如TensorFlow Privacy或Opacus实现。设置合理的隐私预算（ε值，通常在1-10之间），平衡隐私保护与模型性能。
  - 验证差分隐私的效果，确保ε值在可接受范围内，并通过隐私审计工具（如TensorFlow Privacy的审计功能）评估隐私泄露风险。

### 4. **数据加密**

- **措施**：在数据存储和传输过程中使用加密技术，确保数据在静态和动态时都受到保护。
- **操作**：
  - 数据存储：将数据集存储在加密的数据库中（如使用AES-256加密），并确保访问权限严格受限（基于角色访问控制，RBAC）。
  - 数据传输：在数据从存储到训练环境或云端传输时，使用TLS 1.3协议加密通信。
  - 密钥管理：使用密钥管理系统（如AWS KMS、HashiCorp Vault）安全存储和管理加密密钥。

### 5. **联邦学习（可选）**

- **措施**：如果数据分布在多个设备或服务器上，采用联邦学习避免将原始数据集中到单一位置。
- **操作**：
  - 在用户设备或本地服务器上进行模型预训练，仅将模型更新（如梯度）发送到中央服务器。
  - 使用安全聚合协议（如Secure Aggregation）确保中央服务器无法看到单个设备的更新数据。
  - 实施框架如TensorFlow Federated或PySyft来支持联邦学习流程。

### 6. **访问控制与审计**

- **措施**：限制数据集和模型的访问权限，并记录所有访问行为以便审计。
- **操作**：
  - 实施最小权限原则，仅允许必要人员（如数据科学家、模型训练团队）访问数据集。
  - 使用身份认证和多因素认证（MFA）保护访问入口。
  - 部署日志系统（如ELK Stack）记录数据访问和模型训练的操作，定期审计日志以发现异常行为。

### 7. **合规性检查**

- **措施**：确保数据处理流程符合相关法律法规，如GDPR（欧盟）、CCPA（加州消费者隐私法案）或《个人信息保护法》（中国）。
- **操作**：
  - 审查数据集的来源，确保用户已明确同意数据用于模型训练（如通过用户协议或隐私政策）。
  - 如果适用，提供用户撤销同意的机制，并从数据集中删除相关数据。
  - 咨询法律专家，确保隐私保护措施符合当地法规要求。

### 8. **模型隐私保护**

- **措施**：防止模型被逆向工程或通过查询推断出训练数据。
- **操作**：
  - 使用模型蒸馏或知识提炼，将微调后的模型简化为较小的模型，减少信息泄露风险。
  - 在模型推理阶段，限制输出敏感信息。例如，避免直接返回与原始评论高度相关的预测结果。
  - 定期测试模型是否容易受到成员推理攻击（Membership Inference Attack），并根据需要调整训练参数。

### 9. **透明性与用户通知**

- **措施**：向用户披露数据使用方式，增强信任。
- **操作**：
  - 在公司隐私政策中明确说明用户评论可能用于模型训练，并说明已采取的隐私保护措施（如匿名化、差分隐私）。
  - 提供用户查询和删除其数据的渠道，符合GDPR等法规的“被遗忘权”要求。

## 作业3

尝试用你熟悉的 Web 框架（FastAPI/Flask/Django/Spring Boot 等），实现一个简单的、基于 RBAC 的 API 权限控制装饰器。

### 以[FastAPI 框架](https://fastapi.tiangolo.com/)实现

具体代码请查阅 [rbac.py](rbac.py)

### 使用示例

```python
from fastapi import FastAPI, Request
from rbac import requires_permissions

app = FastAPI(title="RBAC权限控制示例")

@app.get("/public")
async def public_endpoint():
    return {"message": "公开接口，无需权限访问"}

@app.get("/data")
@requires_permissions("read")
async def get_data(request: Request):
    return {"message": "需要读取权限的接口数据", "data": [1, 2, 3]}

@app.post("/data")
@requires_permissions("create")
async def create_data(request: Request):
    return {"message": "数据创建成功"}

@app.put("/data/{item_id}")
@requires_permissions("read", "update")
async def update_data(request: Request, item_id: int):
    return {"message": f"数据 {item_id} 更新成功"}

@app.delete("/data/{item_id}")
@requires_permissions("delete")
async def delete_data(request: Request, item_id: int):
    return {"message": f"数据 {item_id} 删除成功"}
```
